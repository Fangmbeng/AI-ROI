# app/agents/business_metrics_agent.py

from typing import List
from vertexai.preview.reasoning_engines import LangchainAgent
from google.adk.agents import LlmAgent

from app.services.integration_service import CRMIntegration, ERPIntegration, FinancialIntegration
from app.services.bigquery_service import BigQueryService
from app.utils.config import PlatformConfig
from app.models.business_metrics import BusinessKPIData


class BusinessMetricsAgent(LlmAgent):
    def __init__(self, config: PlatformConfig, bq_service: BigQueryService):
        # Initialize services BEFORE calling super().__init__()
        # Store them with double underscore to avoid Pydantic field validation
        self.__crm = CRMIntegration(system=config.crm_system)
        self.__erp = ERPIntegration(system=config.erp_system)
        self.__fin = FinancialIntegration(system=config.financial_system)
        self.__bq = bq_service
        
        # Now call parent constructor
        super().__init__(
            name="business_metrics_agent",
            model="gemini-2.0-flash",
            description="Extracts and provides business KPIs from CRM, ERP, and financial systems",
            tools=[
                self.get_revenue_kpis,
                self.get_customer_kpis,
                self.get_operational_kpis,
                self.get_financials,
            ],
        )

    @property
    def crm(self):
        return self.__crm

    @property
    def erp(self):
        return self.__erp

    @property
    def fin(self):
        return self.__fin

    @property
    def bq(self):
        return self.__bq

    def get_revenue_kpis(self) -> List[BusinessKPIData]:
        records = self.crm.fetch_metrics(['revenue'])
        self.bq.insert_rows('business_metrics', records)
        return [BusinessKPIData(**r) for r in records]

    def get_customer_kpis(self) -> List[BusinessKPIData]:
        records = self.crm.fetch_metrics(['customer'])
        self.bq.insert_rows('business_metrics', records)
        return [BusinessKPIData(**r) for r in records]

    def get_operational_kpis(self) -> List[BusinessKPIData]:
        records = self.erp.fetch_metrics(['operations'])
        self.bq.insert_rows('business_metrics', records)
        return [BusinessKPIData(**r) for r in records]

    def get_financials(self) -> List[BusinessKPIData]:
        data = self.fin.fetch_financials(['budget', 'savings'])
        # Convert to KPI records list format
        records = [
            {
                'metric_name': k,
                'metric_value': v,
                'metric_unit': 'USD',
                'timestamp': data['timestamp'],
                'business_unit': 'Finance',
                'ai_system_id': None,
                'metadata': {}
            }
            for k, v in data.items() if k in ['budget', 'savings']
        ]
        self.bq.insert_rows('business_metrics', records)
        return [BusinessKPIData(**r) for r in records]
